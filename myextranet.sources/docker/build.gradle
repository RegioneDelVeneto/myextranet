/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */

plugins {
    id "com.palantir.docker" version "0.25.0"
    id "de.undercouch.download" version "4.0.4"
}

ext.artifactGroup = 'it/regioneveneto/myp3'
ext.artifactName = 'myextranet'
ext.artifactVersion='1.2.3' //per snapshot potrebbe dovrei cambiarlo
ext.artifactExtension='jar'

version='1.2.3' // image version tag
ext.imageName='myextranet'    // name image

// image build arguments
//ext.IMAGE_BASE_VERSION='1.3.14' // versione immagine di base usata nel dockerfile => al momento non si usa una immagine di base
// quando pubblico lo snapshnop lui crea file neme e percorso diverso con data
task downloadFile(type: Download) {
    description "Download file"
    def fileName="${artifactName}-${artifactVersion}.${artifactExtension}"
    def fileNameDest="${artifactName}.${artifactExtension}"
    src "${gradle.mavenReleasesRepoUrl}${artifactGroup}/${artifactName}/${artifactVersion}/${fileName}" //per snapshot va cambiato    
    dest "${buildDir}/docker/${fileNameDest}"
    username "${gradle.mavenCredentialsUsername}"
    password "${gradle.mavenCredentialsPassword}"
    authScheme 'Basic'
    println "DEST ${buildDir}/docker/${fileNameDest}"
     //
}

docker {
    dependsOn downloadFile //se commento la riga e metto il jar da rinominare in myextranet.jar e metto dentro docker
    
    def fileNameDest="${artifactName}.${artifactExtension}"
    
    println "${imageName}:${project.version}"
    println "${buildDir}/docker/${fileNameDest}"

    name "${gradle.registry}/${imageName}:${project.version}"
    dockerfile file('dockerfile')

    // add extra files read by Dockerfile in ADD method
    files   'config/application.yml',
            'config/application-svi.yml',
            'config/application-colleng.yml',
            'config/mybox.properties',
            "${buildDir}/docker/${fileNameDest}",
            //"myextranet.jar",
            'supervisord-rve-myextranet.ini',
            'setup-rve-myextranet.sh',
            'start-rve-myextranet.sh',
            'wait-for-it.sh'
    buildArgs(['http_proxy':"${gradle.http_proxy}",
               'https_proxy':"${gradle.https_proxy}"])
//               'MYPLACE_VERSION':"${IMAGE_BASE_VERSION}"])
}
